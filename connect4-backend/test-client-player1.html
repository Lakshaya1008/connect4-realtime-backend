<!DOCTYPE html>
<html>
<head>
  <title>Player 1 Test</title>
</head>
<body>
<h1>Player 1 - PVP Mode</h1>

<div>
  <button onclick="joinPVP()">Join PVP Game</button>
</div>
<hr>
<div id="gameControls" style="display: none;">
  <button onclick="move(0)">Col 0</button>
  <button onclick="move(1)">Col 1</button>
  <button onclick="move(2)">Col 2</button>
  <button onclick="move(3)">Col 3</button>
  <button onclick="move(4)">Col 4</button>
  <button onclick="move(5)">Col 5</button>
  <button onclick="move(6)">Col 6</button>
</div>

<script>
// Robust Socket.IO loader for static hosting environments
(function(){
  const DEFAULT_LOCAL = 'http://localhost:3000';
  const FALLBACK_PROD = 'https://connect4-realtime-backend.onrender.com';
  const host = window.BACKEND_URL || (window.location.hostname === 'localhost' ? DEFAULT_LOCAL : FALLBACK_PROD);
  const BACKEND_URL = host.replace(/\/+$|\s+/g,'')
  window.BACKEND_URL = BACKEND_URL; // expose for debugging
  console.log('Backend URL:', BACKEND_URL);

  function loadSocketIo(src, cb){
    if (typeof io === 'function') return cb();
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = cb;
    s.onerror = function(){ console.error('Failed to load Socket.IO client from', src); cb(new Error('load_error')); };
    document.head.appendChild(s);
  }

  function init(){
    if (typeof io !== 'function') { console.error('Socket.IO client not available.'); return; }
    const socket = io(BACKEND_URL, { transports: ['websocket'] });
    window.socket = socket;

    let gameId = null;
    let gameActive = false; // FIX: Track game state
    let isProcessingMove = false; // FIX: Prevent rapid clicks
    const username = 'player1';

    socket.on('waiting_for_opponent', () => console.log('â³ WAITING FOR PVP OPPONENT...'));

    socket.on('game_start', (data) => {
      console.log('ðŸŽ® GAME STARTED:', data.gameId);
      console.log('Mode:', data.mode);
      gameId = data.gameId;
      gameActive = true; // FIX: Enable moves
      console.table(data.board);
      document.getElementById('gameControls').style.display = 'block';
    });

    socket.on('game_update', (data) => {
      console.log('TURN:', data.currentTurn);
      console.table(data.board);
      isProcessingMove = false; // FIX: Unlock for next turn
    });

    socket.on('game_over', (data) => {
      gameActive = false; // FIX: Block moves immediately
      isProcessingMove = false; // FIX: Reset lock
      console.log('ðŸ† GAME OVER:', data);
      console.log('Winner:', data.winner);
      console.log('Reason:', data.reason);
      if (data.winningCells) console.log('Winning cells:', data.winningCells);
      document.getElementById('gameControls').style.display = 'none';
    });

    socket.on('game_resume', (data) => {
      console.log('ðŸ”„ GAME RESUMED:', data.gameId);
      gameId = data.gameId;
      gameActive = true; // FIX: Enable moves on resume
      console.table(data.board);
      console.log('Current turn:', data.currentTurn);
      document.getElementById('gameControls').style.display = 'block';
    });

    socket.on('opponent_disconnected', ({ username }) => {
      console.log(`âš ï¸ ${username} disconnected. Waiting for reconnect (30s)...`);
    });

    socket.on('opponent_reconnected', ({ username }) => {
      console.log(`âœ… ${username} reconnected. Game continues!`);
    });

    window.joinPVP = function(){
      console.log('Joining PVP game as', username);
      socket.emit('join_game', { username, mode: 'PVP' });
    };

    window.move = function(col){
      if (!gameId) { console.warn('Game not started yet'); return; }
      // FIX: Guard to prevent moves after game_over
      if (!gameActive) {
        console.warn('â›” Move blocked - game is not active');
        return;
      }
      // FIX: Prevent rapid clicks during move processing
      if (isProcessingMove) {
        console.warn('â›” Move blocked - processing previous move');
        return;
      }
      isProcessingMove = true; // FIX: Lock until backend responds
      console.log('YOU PLAY:', col);
      socket.emit('make_move', { gameId, column: col, username });
    };
  }

  const candidates = [
    (window.BACKEND_URL || BACKEND_URL) + '/socket.io/socket.io.js',
    location.origin + '/socket.io/socket.io.js'
  ];

  (function tryLoad(i){
    if (i >= candidates.length){
      const alt = BACKEND_URL.replace(/^http:/,'https:') + '/socket.io/socket.io.js';
      loadSocketIo(alt, function(err){ if (!err && typeof io === 'function') init(); else console.error('Socket.IO client could not be loaded.'); });
      return;
    }
    loadSocketIo(candidates[i], function(err){ if (!err && typeof io === 'function') init(); else tryLoad(i+1); });
  })(0);
})();
</script>

</body>
</html>
