<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Test</title>
</head>
<body>
<h2>Connect Four - Game Mode Test</h2>

<!-- Game Mode Selection -->
<div style="margin-bottom: 20px;">
    <h3>Start New Game:</h3>
    <button onclick="startGame('BOT', 'EASY')">Play vs BOT (EASY)</button>
    <button onclick="startGame('BOT', 'MEDIUM')">Play vs BOT (MEDIUM)</button>
    <button onclick="startGame('BOT', 'HARD')">Play vs BOT (HARD)</button>
    <button onclick="startGame('PVP')">Play vs Player (PVP)</button>
</div>

<hr>

<!-- Move Buttons -->
<div id="gameControls" style="display: none;">
    <h3>Make Move:</h3>
    <button onclick="move(0)">Col 0</button>
    <button onclick="move(1)">Col 1</button>
    <button onclick="move(2)">Col 2</button>
    <button onclick="move(3)">Col 3</button>
    <button onclick="move(4)">Col 4</button>
    <button onclick="move(5)">Col 5</button>
    <button onclick="move(6)">Col 6</button>
</div>

<script>
// Dynamic Socket.IO loader + robust init to avoid `io is not defined` on static hosts (Render)
(function(){
  // Determine backend URL: try global BACKEND_URL (if injected), else use heuristic
  const DEFAULT_LOCAL = 'http://localhost:3000';
  const FALLBACK_PROD = 'https://connect4-realtime-backend.onrender.com'; // fallback if user deployed there
  const host = window.BACKEND_URL || (window.location.hostname === 'localhost' ? DEFAULT_LOCAL : FALLBACK_PROD);
  const BACKEND_URL = host.replace(/\/+$/,''); // trim trailing slash

  // Expose for debugging (non-secret)
  window.BACKEND_URL = BACKEND_URL;
  console.log('Backend URL:', BACKEND_URL);

  // Load Socket.IO client script dynamically
  function loadSocketIo(src, cb) {
    if (typeof io === 'function') return cb(); // already loaded
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = cb;
    s.onerror = function() { console.error('Failed to load Socket.IO client from', src); cb(new Error('load_error')); };
    document.head.appendChild(s);
  }

  // Initialize app when io is available
  function initApp() {
    if (typeof io !== 'function') {
      console.error('Socket.IO client not available. Aborting socket init.');
      return;
    }

    // Create socket connection explicitly to backend URL and prefer websocket transport
    const socket = io(BACKEND_URL, { transports: ['websocket'] });

    // Make socket available for manual debugging
    window.socket = socket;

    // --- Socket handlers ---
    let gameId;
    const username = 'player1'; // test client fixed username

    socket.on('waiting_for_opponent', () => console.log('â³ WAITING FOR PVP OPPONENT...'));

    socket.on('game_start', (data) => {
      console.log('ðŸŽ® GAME STARTED:', data.gameId);
      console.log('Mode:', data.mode, '| Difficulty:', data.difficulty || 'N/A');
      console.table(data.board);
      gameId = data.gameId;
      document.getElementById('gameControls').style.display = 'block';
    });

    socket.on('game_update', (data) => {
      console.log('TURN:', data.currentTurn);
      console.table(data.board);
    });

    socket.on('game_over', (data) => {
      console.log('ðŸ† GAME OVER:', data);
      document.getElementById('gameControls').style.display = 'none';
    });

    socket.on('game_resume', (data) => {
      console.log('ðŸ”„ GAME RESUMED:', data.gameId);
      console.table(data.board);
      console.log('Current turn:', data.currentTurn);
      gameId = data.gameId;
      document.getElementById('gameControls').style.display = 'block';
    });

    socket.on('opponent_disconnected', ({ username }) => {
      console.log(`âš ï¸ ${username} disconnected. Waiting for reconnect (30s)...`);
    });

    socket.on('opponent_reconnected', ({ username }) => {
      console.log(`âœ… ${username} reconnected. Game continues!`);
    });

    // Expose actions
    window.startGame = function(mode, difficulty='MEDIUM'){
      console.log(`Starting ${mode} game${mode==='BOT'?` (${difficulty})`:''}...`);
      socket.emit('join_game', { username, mode, difficulty });
    };

    window.move = function(col){
      console.log('YOU PLAY:', col);
      socket.emit('make_move', { gameId, column: col, username });
    };
  }

  // Load client and init; attempt several fallbacks: same-origin, explicit BACKEND_URL
  const candidates = [
    (window.BACKEND_URL || BACKEND_URL) + '/socket.io/socket.io.js',
    location.origin + '/socket.io/socket.io.js',
  ];

  let loaded = false;
  (function tryLoad(i){
    if (i >= candidates.length) {
      // As last resort, try HTTPS version of fallback
      const alt = BACKEND_URL.replace(/^http:/,'https:') + '/socket.io/socket.io.js';
      loadSocketIo(alt, function(err){ if (!err) { loaded = true; initApp(); } else { console.error('Socket.IO client could not be loaded from any candidate.'); } });
      return;
    }
    loadSocketIo(candidates[i], function(err){
      if (!err && typeof io === 'function') { loaded = true; initApp(); }
      else tryLoad(i+1);
    });
  })(0);
})();
</script>
</body>
</html>

